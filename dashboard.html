<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Total Training Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root { --primary:#010068; --accent:#FE0000; --bg:#f4f6fb; --white:#fff; --success:#00B67A; --muted:#6b6b88; }
    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{
      font-family:Poppins,system-ui,Segoe UI,Roboto,Helvetica,Arial;
      margin:0; background:var(--bg); color:var(--primary); line-height:1.35;
      display:flex; flex-direction:column; min-height:100vh;
    }
    header{ text-align:center; padding:1rem 1rem .5rem }
    header img{ height:60px; margin-bottom:.35rem }
    h1{ font-size:2rem; font-weight:800; margin:.25rem 0 }
    .sub{ color:var(--muted); font-size:.95rem; margin-top:.15rem }

    .progress-wrap{ width:92%; max-width:560px; margin:.6rem auto 0 }
    .progress-bar{ background:#dcdcf4; height:16px; border-radius:10px; overflow:hidden; position:relative }
    .progress-fill{ height:100%; width:0%; background:linear-gradient(270deg,#FE0000,#010068,#FE0000); background-size:400% 100%; animation:lava 6s ease infinite; transition:width .4s ease-in-out }
    .progress-note{ text-align:center; font-size:.85rem; color:var(--muted); margin-top:.35rem }
    @keyframes lava{ 0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%} }

    main{ width:100%; max-width:980px; margin:0 auto; padding:0 1rem 1rem; flex:1 0 auto }
    #weeksContainer{ display:flex; flex-direction:column; gap:1rem; margin:1rem auto }

    .week{ background:var(--white); border-radius:16px; padding:1rem 1.25rem; box-shadow:0 6px 14px rgba(0,0,0,.08); transition:.25s; overflow:hidden }
    .week:hover{ transform:translateY(-2px); box-shadow:0 8px 18px rgba(0,0,0,.12) }
    .week h2{ margin:0; font-size:1.15rem; font-weight:800; display:flex; justify-content:space-between; align-items:center; cursor:pointer; color:var(--primary) }
    .week h2::after{ content:"â–¼"; font-size:1.1rem; transition:transform .3s ease }
    .week.expanded h2::after{ transform:rotate(180deg) }
    .lesson-list{ max-height:0; overflow:hidden; transition:max-height .5s ease; margin-top:.75rem }
    .lesson-list.active{ max-height:1200px }

    .lesson{ display:grid; grid-template-columns:1fr auto auto; align-items:center; gap:.5rem; padding:.55rem 0; border-bottom:1px solid #eee }
    .lesson:last-child{ border-bottom:none }
    .lesson span.title{ font-weight:600; color:#333 }
    .badge{ background:var(--success); color:#fff; font-weight:700; padding:.2rem .55rem; font-size:.72rem; border-radius:999px; margin-left:.5rem; animation:pop .3s ease-out }
    .badge.dim{ background:#c8cadb; color:#2b2f6d }
    @keyframes pop{ 0%{transform:scale(.7);opacity:0} 100%{transform:scale(1);opacity:1} }

    .btn{
      font-family:inherit; font-weight:700; letter-spacing:.2px;
      background:var(--primary); color:#fff; border:none;
      padding:.45rem .75rem; border-radius:10px; cursor:pointer;
    }
    .btn.secondary{ background:#e7e9fb; color:#0f1370 }
    .btn.danger{ background:#ef4444 }
    .btn.view{ border-radius:8px }
    .btn.mark{ background:#0f1370 }
    .btn.undo{ background:#6b7280 }
    .btn:disabled{ opacity:.6; cursor:not-allowed }

    @media (max-width:700px){
      .lesson{ grid-template-columns:1fr auto; grid-auto-rows:auto }
    }

    /* Footer toolbar: at the very bottom */
    footer{
      flex-shrink:0;
      margin-top:1rem;
      border-top:1px dashed #c9cbe9;
      padding:1rem 1rem 1.25rem;
      background:#eef0ff5c;
    }
    .footer-inner{ width:100%; max-width:980px; margin:0 auto; }
    .tool-title{ font-weight:800; margin:0 0 .6rem; font-size:1.05rem }
    .toolbar{ display:flex; gap:.5rem; flex-wrap:wrap }
    input[type="file"]{ display:none }
    .tip{ margin-top:.35rem; font-size:.85rem; color:var(--muted) }
  </style>
</head>
<body>
  <header>
    <img src="images/logo.png" alt="Total Fitness Logo"/>
    <h1>Total Training Program</h1>
    <p class="sub">All modules are visible. Progress is saved to your device.</p>

    <div class="progress-wrap">
      <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
      <div class="progress-note"><span id="progressText">0% complete</span></div>
    </div>
  </header>

  <main>
    <div id="weeksContainer"></div>
  </main>

  <!-- Footer: Export / Import / Reset now at bottom and font-consistent -->
  <footer>
    <div class="footer-inner">
      <p class="tool-title">Your Progress Controls</p>
      <div class="toolbar">
        <button class="btn secondary" id="exportBtn" type="button">Export Progress</button>
        <label class="btn secondary" for="importFile" role="button" tabindex="0">Import Progress</label>
        <input id="importFile" type="file" accept="application/json"/>
        <button class="btn danger" id="resetBtn" type="button">Reset Progress</button>
      </div>
      <p class="tip">Exports a JSON you can keep or move to another device. Import restores your local progress. Reset clears this device only.</p>
    </div>
  </footer>

  <script type="module">
    import { contentMap } from './content.js';

    // ---------- Storage helpers (localStorage + cookie mirror) ----------
    const COOKIE_DAYS = 365;
    const cookieSet = (k,v,days=COOKIE_DAYS) => {
      const d = new Date(); d.setTime(d.getTime() + (days*24*60*60*1000));
      document.cookie = encodeURIComponent(k)+"="+encodeURIComponent(v)+";expires="+d.toUTCString()+";path=/;SameSite=Lax";
    };
    const cookieGet = (k) => {
      const name = encodeURIComponent(k) + "=";
      return document.cookie.split(";").map(c=>c.trim()).find(c=>c.startsWith(name))?.slice(name.length) ?? null;
    };
    const safeSet = (k,v) => {
      try { localStorage.setItem(k, v); cookieSet(k, v); }
      catch(e){ console.warn("Storage quota or blocked, cookie fallback only.", e); cookieSet(k, v); }
    };
    const safeGet = (k) => localStorage.getItem(k) ?? cookieGet(k);
    const safeRemove = (k) => { try { localStorage.removeItem(k); } catch{} cookieSet(k, "", -1); };

    // ---------- Content structure (always visible; no auth) ----------
    const structure = [
      { title: "Day 1 - Start of Total Training Program", lessons: ["day1-lesson1"], quiz: "day1-quiz" },
      { title: "Week 1 - Basics of Exercise + Basics of Nutrition", lessons: ["week1-lesson1","week1-lesson2"], quiz: "week1-quiz" },
      { title: "Week 2 - Aerobic Exercise + Carbohydrates", lessons: ["week2-lesson1","week2-lesson2"], quiz: "week2-quiz" },
      { title: "Week 3 - Muscle & Metabolism + Protein", lessons: ["week3-lesson1","week3-lesson2"], quiz: "week3-quiz" },
      { title: "Week 4 - Dietary Fats + Principles of Training", lessons: ["week4-lesson1","week4-lesson2"], quiz: "week4-quiz" },
      { title: "Week 5 - Abdominals & Water + Understanding Diets", lessons: ["week5-lesson1","week5-lesson2"], quiz: "week5-quiz" },
      { title: "Week 6 - Plateaus + Whole Grains & Fiber", lessons: ["week6-lesson1","week6-lesson2"], quiz: "week6-quiz" },
      { title: "Week 7 - Micronutrients + Stress & Sleep", lessons: ["week7-lesson1","week7-lesson2"], quiz: "week7-quiz" },
      { title: "Week 8 - Capstone", lessons: ["week8-lesson1","week8-lesson2"], quiz: "week8-quiz" }
    ];

    // Merge cookies -> localStorage (first load on this device)
    (function hydrateFromCookies(){
      structure.forEach(week=>{
        week.lessons.forEach(slug=>{
          const k = `lesson_${slug}_done`;
          if(localStorage.getItem(k) == null && cookieGet(k) != null){
            localStorage.setItem(k, cookieGet(k));
          }
        });
        if(week.quiz){
          const k = `quiz_${week.quiz}_cleared`;
          if(localStorage.getItem(k) == null && cookieGet(k) != null){
            localStorage.setItem(k, cookieGet(k));
          }
        }
      });
      const lastW = cookieGet("lastExpandedWeek");
      if(localStorage.getItem("lastExpandedWeek")==null && lastW!=null){
        localStorage.setItem("lastExpandedWeek", lastW);
      }
    })();

    const container = document.getElementById('weeksContainer');
    const fill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');

    const totalItems = structure.reduce((t,w)=> t + w.lessons.length + (w.quiz?1:0), 0);
    let weekEls = [];

    function render(){
      container.innerHTML = "";
      weekEls = [];
      let completed = 0;

      structure.forEach((week, idx) => {
        const weekDiv = document.createElement('div');
        weekDiv.className = 'week';

        const h2 = document.createElement('h2');
        h2.textContent = week.title;

        const list = document.createElement('div');
        list.className = 'lesson-list';

        // expand/collapse
        h2.addEventListener('click', () => toggleWeek(idx));

        // lessons
        week.lessons.forEach(slug=>{
          const k = `lesson_${slug}_done`;
          const isDone = safeGet(k) === "true";
          if(isDone) completed++;

          const row = document.createElement('div');
          row.className = 'lesson';

          const title = document.createElement('span');
          title.className = 'title';
          title.textContent = contentMap[slug]?.title || slug;

          const b = document.createElement('span');
          b.className = 'badge ' + (isDone ? '' : 'dim');
          b.textContent = isDone ? 'COMPLETED' : 'IN PROGRESS';
          title.appendChild(b);

          const viewBtn = document.createElement('button');
          viewBtn.className = 'btn view';
          viewBtn.textContent = 'View Course';
          viewBtn.addEventListener('click', () => {
            safeSet('lastExpandedWeek', String(idx));
            location.href = `view.html?lesson=${slug}`;
          });

          const markBtn = document.createElement('button');
          markBtn.className = 'btn ' + (isDone ? 'undo' : 'mark');
          markBtn.textContent = isDone ? 'Undo' : 'Mark as Done';
          markBtn.addEventListener('click', () => {
            const newVal = !(safeGet(k) === "true");
            safeSet(k, String(newVal));
            render();
          });

          row.appendChild(title);
          row.appendChild(viewBtn);
          row.appendChild(markBtn);
          list.appendChild(row);
        });

        // quiz
        if(week.quiz){
          const kq = `quiz_${week.quiz}_cleared`;
          const isCleared = safeGet(kq) === "true";
          if(isCleared) completed++;

          const qrow = document.createElement('div');
          qrow.className = 'lesson';

          const span = document.createElement('span');
          span.className = 'title';
          span.innerHTML = `Quiz: ${week.quiz.replace('-quiz','').replace('day','Day ').replace('week','Week ')}`;

          const badge = document.createElement('span');
          badge.className = 'badge ' + (isCleared ? '' : 'dim');
          badge.textContent = isCleared ? 'CLEARED' : 'NOT CLEARED';
          span.appendChild(badge);

          const takeBtn = document.createElement('button');
          takeBtn.className = 'btn view';
          takeBtn.textContent = 'Take Quiz';
          takeBtn.addEventListener('click', ()=>{
            safeSet('lastExpandedWeek', String(idx));
            location.href = `quiz.html?quiz=${week.quiz}`;
          });

          qrow.appendChild(span);
          qrow.appendChild(takeBtn);
          list.appendChild(qrow);
        }

        weekDiv.appendChild(h2);
        weekDiv.appendChild(list);
        container.appendChild(weekDiv);
        weekEls.push({ weekDiv, list });
      });

      // Progress UI
      const pct = Math.round((completed / totalItems) * 100);
      progressText.textContent = `${pct}% complete`;
      setTimeout(()=> { fill.style.width = `${pct}%`; }, 150);

      // Auto-expand last week opened (or first)
      const lastIdx = Number(safeGet('lastExpandedWeek') ?? 0);
      toggleWeek(Number.isFinite(lastIdx) ? lastIdx : 0, true);
    }

    function toggleWeek(idx, forceOpen=false){
      weekEls.forEach((w)=>{ w.weekDiv.classList.remove('expanded'); w.list.classList.remove('active'); });
      const target = weekEls[idx];
      if(!target) return;
      target.weekDiv.classList.add('expanded');
      target.list.classList.add('active');
      safeSet('lastExpandedWeek', String(idx));
    }

    // ---------- Export / Import / Reset ----------
    function collectProgress(){
      const data = { v:1, lastExpandedWeek: safeGet('lastExpandedWeek') ?? "0", lessons:{}, quizzes:{} };
      structure.forEach(week=>{
        week.lessons.forEach(slug=>{
          const k = `lesson_${slug}_done`;
          data.lessons[slug] = safeGet(k) === "true";
        });
        if(week.quiz){
          const kq = `quiz_${week.quiz}_cleared`;
          data.quizzes[week.quiz] = safeGet(kq) === "true";
        }
      });
      return data;
    }

    function applyProgress(data){
      if(!data || typeof data !== 'object') return;
      if(data.lessons){
        Object.entries(data.lessons).forEach(([slug,val])=>{
          safeSet(`lesson_${slug}_done`, String(!!val));
        });
      }
      if(data.quizzes){
        Object.entries(data.quizzes).forEach(([slug,val])=>{
          safeSet(`quiz_${slug}_cleared`, String(!!val));
        });
      }
      if(data.lastExpandedWeek != null) safeSet('lastExpandedWeek', String(data.lastExpandedWeek));
      render();
    }

    document.getElementById('exportBtn').addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify(collectProgress(), null, 2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'total-training-progress.json';
      a.click();
      URL.revokeObjectURL(a.href);
    });

    document.getElementById('importFile').addEventListener('change', (e)=>{
      const file = e.target.files?.[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try { applyProgress(JSON.parse(reader.result)); }
        catch(err){ alert('Invalid progress file.'); }
      };
      reader.readAsText(file);
      e.target.value = "";
    });

    document.getElementById('resetBtn').addEventListener('click', ()=>{
      if(!confirm('Reset all local progress on this device?')) return;
      structure.forEach(week=>{
        week.lessons.forEach(slug=> safeRemove(`lesson_${slug}_done`));
        if(week.quiz) safeRemove(`quiz_${week.quiz}_cleared`);
      });
      safeRemove('lastExpandedWeek');
      render();
    });

    // Cross-tab sync
    window.addEventListener('storage', (e)=>{
      if(!e.key) return;
      if(e.key.startsWith('lesson_') || e.key.startsWith('quiz_') || e.key==='lastExpandedWeek'){
        render();
      }
    });

    render();
  </script>
</body>
</html>
